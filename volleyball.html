<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ligaplaner – Turnier</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 2rem;
        background: #f4f6f9;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: white;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: center;
      }
      th {
        background-color: #003366;
        color: white;
      }
      .highlight {
        background-color: orange;
      }
      .result-input input {
        width: 40px;
        text-align: center;
      }
      .hidden {
        display: none;
      }
      #teamList input {
        margin: 2px;
        padding: 5px 10px;
      }
      #logo {
        display: inline-block;
        vertical-align: middle;
      }
      h1 {
        display: inline-block;
        vertical-align: middle;
        margin-left: 10px;
      }
      img {
        max-width: 200px;
        height: auto;
      }
      /* Hamburger-Menü und Sidebar */
      #hamburgerIcon {
        position: fixed;
        top: 10px;
        left: 20px;
        font-size: 30px;
        cursor: pointer;
        z-index: 999;
      }
      #sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        background-color: #fff;
        box-shadow: 2px 0 5px rgba(0,0,0,0.3);
        padding: 10px;
        transition: left 0.3s ease;
        z-index: 1001;
      }
      #sidebar.open {
        left: 0;
      }
      #sidebar h2 {
        margin-top: 0;
      }
      #sidebar ul {
        list-style: none;
        padding: 0;
      }
      #sidebar li {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #ccc;
      }
      #sidebar li:hover {
        background-color: #f0f0f0;
      }
      /* Container für zwei Tabellen nebeneinander (Standings) */
      .group-tables {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
      }
      /* Navigation (Spieltage) */
      #navigationControls {
        text-align: center;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Hamburger-Menü Icon -->
    <div id="hamburgerIcon" onclick="toggleSidebar()">&#9776;</div>
    <!-- Sidebar -->
    <div id="sidebar">
      <span id="closeSidebar" onclick="toggleSidebar()" style="cursor:pointer; float:right; font-size:30px;">&times;</span>
      <h2>Teams</h2>
      <ul id="sidebarList"></ul>
      <button id="clearFilterButtonSidebar" onclick="clearFilter()">Filter zurücksetzen</button>
    </div>
    <!-- Logo und Titel -->
    <div id="header">
      <div id="logo">
        <img src="Image.png" alt="Campusliga Logo" />
      </div>
      <h1>Volleyball - Vorrunde</h1>
    </div>
    <!-- Versteckter Titel (optional) -->
    <h1 style="display:none;">Ligaplaner – Turnier</h1>
    <!-- Adminbereich: Teams bearbeiten (Adminmodus) -->
    <div id="teamList" class="hidden"></div>
    <!-- Standings: Oben zwei Tabellen (Gruppe A und Gruppe B) -->
    <div id="standingsContainer"></div>
    <!-- Navigation für die Spieltagsansicht -->
    <div id="navigationControls">
      <button onclick="vorherigerSpieltag()">⬅️</button>
      <span id="spieltagLabel">Spieltag 1</span>
      <button onclick="naechsterSpieltag()">➡️</button>
    </div>
    <!-- Spieltagsansicht -->
    <div id="spieltagContainer"></div>
    <!-- Admin: PIN-Eingabe und Speichern -->
    <div style="margin-top:2rem; text-align:center;">
      <input type="password" id="adminPinInput" placeholder="Admin PIN" />
      <button onclick="toggleAdmin()">Anmelden</button>
      <button id="saveButton" onclick="saveAllSpieltagErgebnisse()" style="display:none;">Speichern</button>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
      // Firebase-Konfiguration – passe hier deine Werte an!
      const firebaseConfig = {
        apiKey: "AIzaSyAsneYTXmT7JDUewiJ09LUg1QSZK6Rj_8",
        authDomain: "uni-liga.firebaseapp.com",
        projectId: "uni-liga",
        storageBucket: "uni-liga.appspot.com",
        messagingSenderId: "196698710621",
        appId: "1:196698710621:web:66d13babfc997bab5a3b4"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Globale Variablen
      let isAdmin = false;
      let aktuellerSpieltag = 0;
      // Teams werden wie bei den Teamnamen in einem einzigen Dokument gespeichert
      let teams = {};

      // Standardteams A1–A8, B1–B8
      function generiereStandardTeams() {
        let std = {};
        for (let i = 1; i <= 8; i++) {
          std["A" + i] = "Team A" + i;
          std["B" + i] = "Team B" + i;
        }
        return std;
      }

      // Spieltage 1 bis 4 (Spieltage 5-9 wurden entfernt)
      const spieltage = [
        {
          nummer: 1,
          datum: "",
          spiele: [
            { zeit: "16:15 – 16:30", teamA: "A3", teamB: "A4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:15 – 16:30", teamA: "A5", teamB: "A6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "A3", teamB: "A5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "A4", teamB: "A6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "A1", teamB: "A2", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "A7", teamB: "A8", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "A1", teamB: "A3", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "A7", teamB: "A5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "A2", teamB: "A4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "A8", teamB: "A6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "A4", teamB: "A1", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "A6", teamB: "A7", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "A3", teamB: "A2", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "A8", teamB: "A5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" }
          ]
        },
        {
          nummer: 2,
          datum: "",
          spiele: [
            { zeit: "16:15 – 16:30", teamA: "B3", teamB: "B4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:15 – 16:30", teamA: "B5", teamB: "B6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "B3", teamB: "B5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "B4", teamB: "B6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "B1", teamB: "B2", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "B7", teamB: "B8", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "B1", teamB: "B3", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "B7", teamB: "B5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "B2", teamB: "B4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "B8", teamB: "B6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "B4", teamB: "B1", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "B6", teamB: "B7", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "B3", teamB: "B2", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "B8", teamB: "B5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" }
          ]
        },
        {
          nummer: 3,
          datum: "",
          spiele: [
            { zeit: "16:15 – 16:30", teamA: "A1", teamB: "A8", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:15 – 16:30", teamA: "A2", teamB: "A7", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "A1", teamB: "A7", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "A2", teamB: "A8", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "A3", teamB: "A6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "A4", teamB: "A5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "A1", teamB: "A6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "A2", teamB: "A5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "A7", teamB: "A3", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "A8", teamB: "A4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "A1", teamB: "A5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "A2", teamB: "A6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "A7", teamB: "A4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "A8", teamB: "A3", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" }
          ]
        },
        {
          nummer: 4,
          datum: "",
          spiele: [
            { zeit: "16:15 – 16:30", teamA: "B1", teamB: "B8", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:15 – 16:30", teamA: "B2", teamB: "B7", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "B1", teamB: "B7", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:35 – 16:50", teamA: "B2", teamB: "B8", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "B3", teamB: "B6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "16:55 – 17:10", teamA: "B4", teamB: "B5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "B1", teamB: "B6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:15 – 17:30", teamA: "B2", teamB: "B5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "B7", teamB: "B3", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:35 – 17:50", teamA: "B8", teamB: "B4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "B1", teamB: "B5", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "17:55 – 18:10", teamA: "B2", teamB: "B6", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "B7", teamB: "B4", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" },
            { zeit: "18:15 – 18:30", teamA: "B8", teamB: "B3", goalsA: "", goalsB: "", feld: "Feld 1", schiedsrichter: "" }
          ]
        }
      ];

      // -------------------------------------------------------
      // Firestore: Spieltage in einem einzigen Dokument speichern (analog zu den Teams)
      // -------------------------------------------------------
      function saveAllSpieltagErgebnisse() {
        db.collection("metadata").doc("spieltage").set({ spieltage: spieltage })
          .then(() => {
            alert("Alle Spieltage gespeichert!");
            renderStandings();
          })
          .catch(error => {
            console.error("Fehler beim Speichern der Spieltage:", error);
          });
      }

      // -------------------------------------------------------
      // Firestore: Lade Spieltage aus einem einzelnen Dokument
      // -------------------------------------------------------
      function ladeSpieltage() {
        db.collection("metadata").doc("spieltage").get()
          .then(doc => {
            if (doc.exists) {
              // Überschreibt den lokalen Array, falls Daten vorhanden sind
              const data = doc.data();
              if(data.spieltage) {
                spieltage.splice(0, spieltage.length, ...data.spieltage);
              }
            }
            renderStandings();
            renderSpieltag();
          })
          .catch(error => {
            console.error("Fehler beim Laden der Spieltage:", error);
            renderStandings();
            renderSpieltag();
          });
      }

      // -------------------------------------------------------
      // Firestore: Teams laden/speichern (wie gehabt)
      // -------------------------------------------------------
      function ladeTeamDaten() {
        db.collection("metadata").doc("teams").get()
          .then(doc => {
            if (doc.exists) {
              teams = doc.data().teams || {};
            }
            if (
              Object.keys(teams).length === 0 ||
              !Object.keys(teams).some(key => key.startsWith("A") || key.startsWith("B"))
            ) {
              teams = generiereStandardTeams();
              saveTeamsMappingToFirebase();
            }
            renderTeamList();
            renderSidebarTeamList();
            renderDefaultView();
            ladeSpieltage();  // Nach dem Laden der Teams auch die Spieltage laden.
          })
          .catch(error => {
            console.error("Fehler beim Laden der Teams:", error);
            teams = generiereStandardTeams();
            renderTeamList();
            renderSidebarTeamList();
            renderDefaultView();
            ladeSpieltage();
          });
      }

      function saveTeamsMappingToFirebase() {
        db.collection("metadata").doc("teams").set({ teams: teams })
          .then(() => console.log("Teams mapping in Firebase gespeichert!"))
          .catch(error => console.error("Fehler beim Speichern der Teams:", error));
      }

      // -------------------------------------------------------
      // Adminmodus: Teams bearbeiten (in zwei Spalten)
      // -------------------------------------------------------
      function toggleAdmin() {
        const pin = document.getElementById("adminPinInput").value;
        if (pin === "3141") {
          isAdmin = true;
          document.getElementById("saveButton").style.display = "inline-block";
        } else {
          alert("Falscher PIN");
        }
        renderTeamList();
        renderSidebarTeamList();
        renderDefaultView();
      }

      function renderTeamList() {
        const teamListDiv = document.getElementById("teamList");
        if (isAdmin) {
          teamListDiv.classList.remove("hidden");
          let aDiv = document.createElement("div");
          aDiv.style.display = "inline-block";
          aDiv.style.verticalAlign = "top";
          aDiv.style.marginRight = "30px";
          let bDiv = document.createElement("div");
          bDiv.style.display = "inline-block";
          bDiv.style.verticalAlign = "top";
          aDiv.innerHTML = "<h2>Teams Gruppe A</h2>";
          bDiv.innerHTML = "<h2>Teams Gruppe B</h2>";
          for (const teamID in teams) {
            let container = document.createElement("div");
            container.style.marginBottom = "5px";
            if (teamID.startsWith("A")) {
              container.innerHTML = `<label style="margin-right:10px;">${teamID}:</label>
                                     <input type="text" value="${teams[teamID]}" onchange="teams['${teamID}'] = this.value; saveTeamsMappingToFirebase(); renderTeamList(); renderSidebarTeamList(); renderDefaultView();" />`;
              aDiv.appendChild(container);
            } else if (teamID.startsWith("B")) {
              container.innerHTML = `<label style="margin-right:10px;">${teamID}:</label>
                                     <input type="text" value="${teams[teamID]}" onchange="teams['${teamID}'] = this.value; saveTeamsMappingToFirebase(); renderTeamList(); renderSidebarTeamList(); renderDefaultView();" />`;
              bDiv.appendChild(container);
            }
          }
          teamListDiv.innerHTML = "";
          teamListDiv.appendChild(aDiv);
          teamListDiv.appendChild(bDiv);
        } else {
          teamListDiv.classList.add("hidden");
        }
      }

      // -------------------------------------------------------
      // Sidebar
      // -------------------------------------------------------
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("open");
        const hamburgerIcon = document.getElementById("hamburgerIcon");
        hamburgerIcon.style.display = sidebar.classList.contains("open") ? "none" : "block";
      }

      function renderSidebarTeamList() {
        const sidebarUl = document.getElementById("sidebarList");
        sidebarUl.innerHTML = "";
        for (const teamID in teams) {
          if (teamID.startsWith("A") || teamID.startsWith("B")) {
            let li = document.createElement("li");
            li.textContent = teams[teamID];
            li.style.cursor = "pointer";
            li.onclick = function() {
              let lis = sidebarUl.getElementsByTagName("li");
              for (let item of lis) { item.classList.remove("highlight"); }
              li.classList.add("highlight");
              renderTeamSchedule(teamID);
            };
            sidebarUl.appendChild(li);
          }
        }
      }

      function clearFilter() {
        const sidebarUl = document.getElementById("sidebarList");
        let lis = sidebarUl.getElementsByTagName("li");
        for (let item of lis) { item.classList.remove("highlight"); }
        document.getElementById("navigationControls").style.display = "block";
        renderDefaultView();
      }

      // -------------------------------------------------------
      // Standardansicht: Standings und Spieltagsansicht
      // -------------------------------------------------------
      function renderDefaultView() {
        renderStandings();
        renderSpieltag();
      }

      // -------------------------------------------------------
      // Standings: Zwei Tabellen (Gruppe A und Gruppe B) – Spalten: Team, Spiele, Siege, Punkte
      // -------------------------------------------------------
      function renderStandings() {
        const container = document.getElementById("standingsContainer");
        container.innerHTML = "";
        let standingsA = computeGroupStats("A");
        let standingsB = computeGroupStats("B");
        let tableA = createStandingsTable(standingsA, "Gruppe A");
        let tableB = createStandingsTable(standingsB, "Gruppe B");
        const wrapper = document.createElement("div");
        wrapper.className = "group-tables";
        wrapper.appendChild(tableA);
        wrapper.appendChild(tableB);
        container.appendChild(wrapper);
      }

      function computeGroupStats(prefix) {
        let stats = {};
        for (const teamID in teams) {
          if (teamID.startsWith(prefix)) {
            stats[teamID] = { games: 0, wins: 0, gf: 0, ga: 0 };
          }
        }
        let relevantIndices = (prefix === "A") ? [0,2] : [1,3];
        relevantIndices.forEach(idx => {
          if (spieltage[idx] && spieltage[idx].spiele) {
            spieltage[idx].spiele.forEach(match => {
              let gA = parseInt(match.goalsA, 10);
              let gB = parseInt(match.goalsB, 10);
              if (!isNaN(gA) && !isNaN(gB)) {
                if (match.teamA.startsWith(prefix)) {
                  stats[match.teamA].games++;
                  stats[match.teamA].gf += gA;
                  stats[match.teamA].ga += gB;
                  if (gA > gB) stats[match.teamA].wins++;
                }
                if (match.teamB.startsWith(prefix)) {
                  stats[match.teamB].games++;
                  stats[match.teamB].gf += gB;
                  stats[match.teamB].ga += gA;
                  if (gB > gA) stats[match.teamB].wins++;
                }
              }
            });
          }
        });
        let sorted = Object.entries(stats).sort((a, b) => {
          let winsA = a[1].wins, winsB = b[1].wins;
          if (winsB !== winsA) return winsB - winsA;
          let diffA = a[1].gf - a[1].ga;
          let diffB = b[1].gf - b[1].ga;
          return diffB - diffA;
        });
        return sorted;
      }

      function createStandingsTable(sortedStats, groupLabel) {
        let table = document.createElement("table");
        let caption = document.createElement("caption");
        caption.textContent = groupLabel;
        table.appendChild(caption);
        let thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>Team</th>
            <th>Spiele</th>
            <th>Siege</th>
            <th>Punkte</th>
          </tr>
        `;
        table.appendChild(thead);
        let tbody = document.createElement("tbody");
        sortedStats.forEach(([teamID, stat]) => {
          let points = `${stat.gf} : ${stat.ga}`;
          let row = document.createElement("tr");
          row.innerHTML = `
            <td>${teams[teamID]}</td>
            <td>${stat.games}</td>
            <td>${stat.wins}</td>
            <td>${points}</td>
          `;
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        return table;
      }

      // -------------------------------------------------------
      // Spieltagsansicht: Mit den Spalten "Feld", "Zeit", "Team A", "Team B", "Ergebnis", "Schiedsrichter"
      // -------------------------------------------------------
      function renderSpieltag() {
        const container = document.getElementById("spieltagContainer");
        container.innerHTML = "";
        const currentDay = spieltage[aktuellerSpieltag].nummer;
        document.getElementById("spieltagLabel").textContent = "Spieltag " + currentDay;
        let table = document.createElement("table");
        let caption = document.createElement("caption");
        caption.textContent = "Spieltag " + currentDay;
        table.appendChild(caption);
        let thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Feld</th><th>Zeit</th><th>Team A</th><th>Team B</th><th>Ergebnis</th><th>Schiedsrichter</th></tr>";
        table.appendChild(thead);
        let tbody = document.createElement("tbody");
        const fixtures = (spieltage[aktuellerSpieltag].spiele) || [];
        fixtures.forEach((match, index) => {
          let row = document.createElement("tr");
          let feldCell = "";
          if (isAdmin) {
            feldCell = `<select onchange="updateGame(${aktuellerSpieltag}, ${index}, 'feld', this.value)">
                          <option value="Feld 1" ${match.feld === "Feld 1" ? "selected" : ""}>Feld 1</option>
                          <option value="Feld 2" ${match.feld === "Feld 2" ? "selected" : ""}>Feld 2</option>
                        </select>`;
          } else {
            feldCell = match.feld ? match.feld : "Feld 1";
          }
          let zeitCell = match.zeit;
          let teamAName = teams[match.teamA] || match.teamA;
          let teamBName = teams[match.teamB] || match.teamB;
          let ergebnis = "-";
          if (isAdmin) {
            ergebnis = `<div class="result-input">
                          <input type="number" min="0" value="${match.goalsA}" onchange="updateGame(${aktuellerSpieltag}, ${index}, 'goalsA', this.value)" />
                          <span>:</span>
                          <input type="number" min="0" value="${match.goalsB}" onchange="updateGame(${aktuellerSpieltag}, ${index}, 'goalsB', this.value)" />
                        </div>`;
          } else if (match.goalsA !== "" && match.goalsB !== "") {
            ergebnis = match.goalsA + " : " + match.goalsB;
          }
          let schiedsrichterCell = "";
          if (isAdmin) {
            let options = "<option value=''>-- wählen --</option>";
            for (const key in teams) {
              if (key.startsWith("A") || key.startsWith("B")) {
                let selected = (match.schiedsrichter === key) ? "selected" : "";
                options += `<option value="${key}" ${selected}>${teams[key]}</option>`;
              }
            }
            schiedsrichterCell = `<select onchange="updateGame(${aktuellerSpieltag}, ${index}, 'schiedsrichter', this.value)">
                                    ${options}
                                  </select>`;
          } else {
            schiedsrichterCell = match.schiedsrichter ? teams[match.schiedsrichter] : "";
          }
          row.innerHTML = `
            <td>${feldCell}</td>
            <td>${zeitCell}</td>
            <td>${teamAName}</td>
            <td>${teamBName}</td>
            <td>${ergebnis}</td>
            <td>${schiedsrichterCell}</td>
          `;
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);
      }

      // Aktualisiert ein Feld in einem Spielobjekt
      function updateGame(spieltagIndex, spielIndex, field, value) {
        console.log("updateGame:", field, value, "Spieltag", spieltage[spieltagIndex].nummer, "Spiel", spielIndex);
        if (spieltage[spieltagIndex].spiele) {
          spieltage[spieltagIndex].spiele[spielIndex][field] = value;
        }
      }

      function vorherigerSpieltag() {
        if (aktuellerSpieltag > 0) {
          aktuellerSpieltag--;
          renderSpieltag();
        }
      }

      function naechsterSpieltag() {
        if (aktuellerSpieltag < spieltage.length - 1) {
          aktuellerSpieltag++;
          renderSpieltag();
        }
      }

      // -------------------------------------------------------
      // Team-Filter: Alle Spiele eines Teams anzeigen und in den Standings hervorheben
      // -------------------------------------------------------
      function renderTeamSchedule(teamID) {
        document.getElementById("navigationControls").style.display = "none";
        const standingsContainer = document.getElementById("standingsContainer");
        let cells = standingsContainer.getElementsByTagName("td");
        for (let cell of cells) {
          if (cell.innerText === teams[teamID]) {
            cell.style.backgroundColor = "orange";
          } else {
            cell.style.backgroundColor = "";
          }
        }
        const container = document.getElementById("spieltagContainer");
        container.innerHTML = "";
        let header = document.createElement("h2");
        header.textContent = "Spiele von " + teams[teamID];
        container.appendChild(header);
        let matches = [];
        spieltage.forEach(tag => {
          if (tag.spiele) {
            tag.spiele.forEach(match => {
              if (match.teamA === teamID || match.teamB === teamID) {
                matches.push({
                  spieltag: tag.nummer,
                  zeit: match.zeit,
                  teamA: match.teamA,
                  teamB: match.teamB,
                  goalsA: match.goalsA,
                  goalsB: match.goalsB,
                  feld: match.feld,
                  schiedsrichter: match.schiedsrichter
                });
              }
            });
          }
        });
        if (matches.length === 0) {
          let p = document.createElement("p");
          p.textContent = "Keine Spiele gefunden.";
          container.appendChild(p);
          return;
        }
        let table = document.createElement("table");
        let thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Spieltag</th><th>Zeit</th><th>Team A</th><th>Team B</th><th>Ergebnis</th><th>Feld</th><th>Schiedsrichter</th></tr>";
        table.appendChild(thead);
        let tbody = document.createElement("tbody");
        matches.forEach(m => {
          let erg = "-";
          if (m.goalsA !== "" && m.goalsB !== "") {
            erg = m.goalsA + " : " + m.goalsB;
          }
          let row = document.createElement("tr");
          row.innerHTML = `
            <td>${m.spieltag}</td>
            <td>${m.zeit}</td>
            <td>${teams[m.teamA] || m.teamA}</td>
            <td>${teams[m.teamB] || m.teamB}</td>
            <td>${erg}</td>
            <td>${m.feld || "Feld 1"}</td>
            <td>${m.schiedsrichter ? teams[m.schiedsrichter] : ""}</td>
          `;
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);
      }

      // -------------------------------------------------------
      // Speichert alle Spieltage in einem einzigen Dokument in Firestore
      // (Analog zu den Teamnamen, siehe teams in metadata/teams)
      // -------------------------------------------------------
      function saveAllSpieltagErgebnisse() {
        db.collection("metadata").doc("spieltage").set({ spieltage: spieltage })
          .then(() => {
            alert("Alle Spieltage gespeichert!");
            renderStandings();
          })
          .catch(error => {
            console.error("Fehler beim Speichern der Spieltage:", error);
          });
      }

      // -------------------------------------------------------
      // Lade Spieltage aus Firestore (wenn vorhanden)
      // -------------------------------------------------------
      function ladeSpieltage() {
        db.collection("metadata").doc("spieltage").get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              if(data.spieltage) {
                spieltage.splice(0, spieltage.length, ...data.spieltage);
              }
            }
            renderStandings();
            renderSpieltag();
          })
          .catch(error => {
            console.error("Fehler beim Laden der Spieltage:", error);
            renderStandings();
            renderSpieltag();
          });
      }

      // -------------------------------------------------------
      // Initialisierung: Lade Teams und Spieltage
      // -------------------------------------------------------
      function ladeTeamDaten() {
        db.collection("metadata").doc("teams").get()
          .then(doc => {
            if (doc.exists) {
              teams = doc.data().teams || {};
            }
            if (
              Object.keys(teams).length === 0 ||
              !Object.keys(teams).some(key => key.startsWith("A") || key.startsWith("B"))
            ) {
              teams = generiereStandardTeams();
              saveTeamsMappingToFirebase();
            }
            renderTeamList();
            renderSidebarTeamList();
            renderDefaultView();
            ladeSpieltage(); // Nach dem Laden der Teams auch die Spieltage laden
          })
          .catch(error => {
            console.error("Fehler beim Laden der Teams:", error);
            teams = generiereStandardTeams();
            renderTeamList();
            renderSidebarTeamList();
            renderDefaultView();
            ladeSpieltage();
          });
      }

      ladeTeamDaten();
    </script>
  </body>
</html>

